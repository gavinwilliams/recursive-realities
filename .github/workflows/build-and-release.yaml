name: Build, Convert & Release eBooks

on:
  push:
    branches: [ main ]
  release:
    types: [ created ]
  workflow_dispatch:

jobs:
  build:
    name: Convert Markdown to PDF, EPUB & HTML
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Pandoc + LaTeX)
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-latex-recommended texlive-fonts-recommended texlive-latex-extra

      - name: Create build directory
        run: mkdir -p build

      - name: Convert Markdown files
        run: |
          for file in src/*.md; do
            base=$(basename "$file" .md)
            pandoc "$file" -o "build/${base}.pdf" --pdf-engine=xelatex
            pandoc "$file" -o "build/${base}.epub"
            pandoc "$file" -o "build/${base}.html" --standalone --metadata title="${base}"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ebooks
          path: build/

  release:
    name: Publish eBooks to Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
      - name: Download built artifacts
        uses: actions/download-artifact@v4
        with:
          name: ebooks
          path: build/

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}