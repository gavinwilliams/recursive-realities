name: Auto Version, Build & Release eBooks

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-and-release.yaml'
      - 'src/**'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  tag:
    name: Auto Version Tag
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.create_tag.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate daily incremental version tag
        id: create_tag
        run: |
          DATE_TAG="$(date +'%Y.%m.%d')"
          LATEST_TAG=$(git tag --list "${DATE_TAG}.*" | sort -V | tail -n 1)
          if [ -z "$LATEST_TAG" ]; then
            BUILD_NUMBER=1
          else
            BUILD_NUMBER=$(( $(echo "$LATEST_TAG" | sed -E "s/.*\.([0-9]+)/\1/") + 1 ))
          fi
          NEW_TAG="${DATE_TAG}.${BUILD_NUMBER}"
          echo "Creating new tag: $NEW_TAG"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$NEW_TAG"
          git push origin "$NEW_TAG"
          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT

  build:
    name: Convert Markdown to PDF, EPUB & HTML
    runs-on: ubuntu-latest
    needs: tag
    container:
      image: pandoc/latex:latest-ubuntu
      env:
        LANG: C.UTF-8

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create build directory
        run: mkdir -p build

      - name: Convert Combined Book to PDF, EPUB & HTML
        run: |
          cd src
          echo "ðŸŸ¢ Starting Pandoc conversions for The Consciousness Files..."
          BOOK_FILE="The_Consciousness_Files.md"
          BOOK_NAME="The_Consciousness_Files"
          
          if [ ! -f "$BOOK_FILE" ]; then
            echo "âš ï¸ Book file not found: $BOOK_FILE"
            exit 1
          fi
          
          echo "âš™ï¸ Converting $BOOK_FILE â†’ PDF..."
          pandoc "$BOOK_FILE" -f markdown -t pdf -o "../build/${BOOK_NAME}.pdf" --pdf-engine=xelatex --verbose
          echo "âœ… PDF done"
          
          echo "âš™ï¸ Converting $BOOK_FILE â†’ EPUB..."
          pandoc "$BOOK_FILE" -f markdown -t epub -o "../build/${BOOK_NAME}.epub" --verbose
          echo "âœ… EPUB done"
          
          echo "âš™ï¸ Converting $BOOK_FILE â†’ HTML..."
          pandoc "$BOOK_FILE" -f markdown -t html -o "../build/${BOOK_NAME}.html" --standalone --metadata title="${BOOK_NAME}" --verbose
          echo "âœ… HTML done"
          
          echo "ðŸ All conversions completed."

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ebooks
          path: build/

  release:
    name: Create or Update GitHub Release
    needs: [tag, build]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag exists
        run: |
          echo "Checking for tag: ${{ needs.tag.outputs.tag_name }}"
          git fetch --tags
          if ! git rev-parse "${{ needs.tag.outputs.tag_name }}" >/dev/null 2>&1; then
            echo "âŒ Tag ${{ needs.tag.outputs.tag_name }} not found! Exiting."
            exit 1
          fi

      - name: Wait for tag propagation
        run: sleep 10

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ebooks
          path: build/

      - name: Generate release summary for single book
        id: generate_summary
        run: |
          echo "## ðŸ“š Release Summary â€” ${{ needs.tag.outputs.tag_name }}" > release-summary.md
          echo "" >> release-summary.md
          echo "**The Consciousness Files** â€” A unified collection combining all stories as chapters in one book." >> release-summary.md
          echo "" >> release-summary.md
          echo "Available in multiple formats:" >> release-summary.md
          echo "" >> release-summary.md
          cd build
          for f in *; do
            FILE_NAME=$(basename "$f")
            echo "- [${FILE_NAME}](https://github.com/${{ github.repository }}/releases/download/${{ needs.tag.outputs.tag_name }}/${FILE_NAME})" >> ../release-summary.md
          done
          echo "" >> ../release-summary.md
          echo "_Generated automatically by GitHub Actions._" >> ../release-summary.md

      - name: Create GitHub release with assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.tag.outputs.tag_name }}
          name: "Release ${{ needs.tag.outputs.tag_name }}"
          body_path: release-summary.md
          files: build/*
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post release summary as PR comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: "ðŸ“˜ eBook Release Summary"
          path: release-summary.md